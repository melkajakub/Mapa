<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Turn your walks into an exploration adventure. Discover territory as you explore the world.">
    <title>ExploreMap - Discover Your World</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRXhwbG9yZU1hcCAtIERpc2NvdmVyIFlvdXIgV29ybGQiLCJzaG9ydF9uYW1lIjoiRXhwbG9yZU1hcCIsImRlc2NyaXB0aW9uIjoiVHVybiB5b3VyIHdhbGtzIGludG8gYW4gZXhwbG9yYXRpb24gZ2FtZSIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGYxNzJhIiwidGhlbWVfY29sb3IiOiIjMGYxNzJhIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgNTEyIDUxMicgZmlsbD0nJTIzNjBhNWZhJyUzRSUzQ3BhdGggZD0nTTI1NiAzMmM0MSAwIDc1IDM0IDc1IDc1IDAgOC0xIDE2LTMgMjMgMTAgMiAxOSA2IDI3IDExIDctNyAxNS0xMiAyNC0xNSA0LTEgOC0yIDEzLTIgNDEgMCA3NSAzNCA3NSA3NSAwIDI4LTE1IDUzLTM4IDY2IDE1IDEzIDI1IDMyIDI1IDUzIDAgNDEtMzQgNzUtNzUgNzUtOCAwLTE1LTEtMjItNCA1IDMzLTMyIDU5LTY2IDU5LTM3IDAtNjctMzAtNjctNjd2LTM0YzAgNDEtMzQgNzUtNzUgNzUtNDEgMC03NS0zNC03NS03NSAwLTIxIDktNDAgMjQtNTMtMjMtMTMtMzgtMzgtMzgtNjYgMC00MSAzNC03NSA3NS03NSA1IDAgMTAgMSAxNCAyIDktMyAxNy04IDI1LTE1IDgtNSAxNy05IDI3LTExLTItNy0zLTE1LTMtMjMgMC00MSAzNC03NSA3NS03NXonLyUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors - Dark Theme */
            --bg-primary: #0a0e1a;
            --bg-secondary: #151b2e;
            --bg-tertiary: #1e2740;
            --accent-primary: #00d9ff;
            --accent-secondary: #a855f7;
            --accent-success: #22c55e;
            --accent-warning: #fbbf24;
            --accent-danger: #ef4444;
            --text-primary: #f0f4ff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: rgba(148, 163, 184, 0.1);
            --shadow: rgba(0, 0, 0, 0.5);
            
            /* Typography */
            --font-display: 'Outfit', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 400ms ease;
        }

        body {
            font-family: var(--font-display);
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* Animated Background */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.4;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 217, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 80%, rgba(34, 197, 94, 0.1) 0%, transparent 50%);
            animation: gradientShift 20s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(5deg); }
        }

        /* Main Layout */
        .app-container {
            position: relative;
            z-index: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: rgba(10, 14, 26, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: var(--space-md) var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .header-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .btn {
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-full);
            border: none;
            font-family: var(--font-display);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: 0 4px 20px rgba(0, 217, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0, 217, 255, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
        }

        /* Map Container */
        .map-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Discovery Overlay Canvas */
        .discovery-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 400;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            bottom: 100px;
            right: var(--space-lg);
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            z-index: 500;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: rgba(30, 39, 64, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: scale(1.1);
        }

        /* Bottom Navigation */
        .bottom-nav {
            background: rgba(10, 14, 26, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            padding: var(--space-md);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: var(--space-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            flex: 1;
            text-align: center;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--accent-primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: var(--radius-full);
        }

        .nav-icon {
            font-size: 24px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Panels */
        .panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 26, 0.98);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: none;
            overflow-y: auto;
            padding: var(--space-lg);
            padding-top: 80px;
            animation: slideIn 0.3s ease;
        }

        .panel.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
        }

        .panel-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .close-btn:hover {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            transform: rotate(90deg);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            position: relative;
            overflow: hidden;
            transition: all var(--transition-base);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            box-shadow: 0 12px 40px rgba(0, 217, 255, 0.2);
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: var(--space-sm);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            font-family: var(--font-mono);
            margin-bottom: 4px;
            background: linear-gradient(135deg, var(--text-primary), var(--accent-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* Achievements Grid */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: var(--space-md);
        }

        .achievement-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            text-align: center;
            transition: all var(--transition-base);
            cursor: pointer;
            position: relative;
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-card.unlocked {
            border-color: var(--accent-success);
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.2);
        }

        .achievement-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: var(--space-sm);
        }

        .achievement-name {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .achievement-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .achievement-progress {
            margin-top: var(--space-sm);
            font-size: 11px;
            font-family: var(--font-mono);
            color: var(--accent-primary);
        }

        /* Leaderboard */
        .leaderboard-list {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .leaderboard-row {
            display: grid;
            grid-template-columns: 60px 50px 1fr auto auto;
            gap: var(--space-md);
            align-items: center;
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-color);
            transition: all var(--transition-fast);
        }

        .leaderboard-row:last-child {
            border-bottom: none;
        }

        .leaderboard-row:hover {
            background: var(--bg-tertiary);
        }

        .leaderboard-row.current-user {
            background: rgba(0, 217, 255, 0.1);
            border-left: 3px solid var(--accent-primary);
        }

        .rank {
            font-size: 24px;
            font-weight: 800;
            font-family: var(--font-mono);
            color: var(--accent-primary);
        }

        .rank.top-3 {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            border: 2px solid var(--border-color);
        }

        .nickname {
            font-weight: 600;
        }

        .stat-distance {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--accent-primary);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
        }

        .modal-body {
            margin-bottom: var(--space-lg);
        }

        .modal-body p {
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        .modal-footer {
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-display);
            font-size: 14px;
            transition: all var(--transition-base);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Confetti for achievements */
        .confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: var(--space-sm) var(--space-md);
            }

            .logo {
                font-size: 18px;
            }

            .logo-icon {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            .panel-title {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .map-controls {
                bottom: 90px;
                right: var(--space-md);
            }
        }

        /* Premium Badge */
        .premium-badge {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #000;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Streak Fire */
        .streak-container {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: var(--bg-secondary);
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            margin-bottom: var(--space-xl);
        }

        .streak-fire {
            font-size: 48px;
            animation: flicker 2s ease-in-out infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .streak-info h3 {
            font-size: 32px;
            font-weight: 800;
            font-family: var(--font-mono);
        }

        .streak-info p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
            background: var(--bg-tertiary);
        }

        .upload-area:hover {
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
        }

        .upload-area.dragover {
            border-color: var(--accent-primary);
            background: rgba(0, 217, 255, 0.1);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: var(--space-md);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: var(--space-sm);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width var(--transition-slow);
            border-radius: var(--radius-full);
        }

        /* Onboarding */
        .onboarding {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            text-align: center;
        }

        .onboarding-step {
            max-width: 500px;
            animation: fadeIn 0.5s ease;
        }

        .onboarding-icon {
            font-size: 120px;
            margin-bottom: var(--space-xl);
        }

        .onboarding h2 {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: var(--space-md);
        }

        .onboarding p {
            font-size: 18px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: var(--space-xl);
        }

        .onboarding-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    
    <!-- Onboarding (shown on first visit) -->
    <div class="onboarding" id="onboarding" style="display: none;">
        <div class="onboarding-step" id="onboarding-step">
            <div class="onboarding-icon">üó∫Ô∏è</div>
            <h2>Welcome to ExploreMap!</h2>
            <p>Turn your walks into an exploration adventure. Discover territory as you explore the world.</p>
            <div class="onboarding-actions">
                <button class="btn btn-primary" onclick="startOnboarding()">Get Started</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üó∫Ô∏è</div>
                <span>ExploreMap</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- Map -->
        <div class="map-wrapper">
            <div id="map"></div>
            <canvas class="discovery-overlay" id="discoveryCanvas"></canvas>
            
            <div class="map-controls">
                <button class="control-btn" onclick="zoomIn()" title="Zoom In">+</button>
                <button class="control-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
                <button class="control-btn" onclick="recenter()" title="Recenter">üéØ</button>
                <button class="control-btn" onclick="toggleLayer()" title="Toggle Layer">üó∫Ô∏è</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showPanel('map')">
                <div class="nav-icon">üó∫Ô∏è</div>
                <div class="nav-label">Map</div>
            </div>
            <div class="nav-item" onclick="showPanel('stats')">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">Stats</div>
            </div>
            <div class="nav-item" onclick="showPanel('achievements')">
                <div class="nav-icon">üèÜ</div>
                <div class="nav-label">Badges</div>
            </div>
            <div class="nav-item" onclick="showPanel('leaderboard')">
                <div class="nav-icon">üëë</div>
                <div class="nav-label">Top 100</div>
            </div>
        </nav>
    </div>

    <!-- Stats Panel -->
    <div class="panel" id="statsPanel">
        <div class="panel-header">
            <h2 class="panel-title">Your Statistics</h2>
            <button class="close-btn" onclick="closePanel('stats')">√ó</button>
        </div>

        <div class="streak-container">
            <div class="streak-fire">üî•</div>
            <div class="streak-info">
                <h3><span id="streakCount">0</span> Days</h3>
                <p>Current Streak</p>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üåç</div>
                <div class="stat-value" id="totalKm">0.0</div>
                <div class="stat-label">Total km</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìç</div>
                <div class="stat-value" id="todayKm">0.0</div>
                <div class="stat-label">Today km</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üó∫Ô∏è</div>
                <div class="stat-value" id="countries">0</div>
                <div class="stat-label">Countries</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üèôÔ∏è</div>
                <div class="stat-value" id="cities">0</div>
                <div class="stat-label">Cities</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë£</div>
                <div class="stat-value" id="totalSteps">0</div>
                <div class="stat-label">Total Steps</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üî≠</div>
                <div class="stat-value" id="viewpoints">0</div>
                <div class="stat-label">Viewpoints</div>
            </div>
        </div>

        <button class="btn btn-primary" style="width: 100%; margin-top: var(--space-lg);" onclick="openImportModal()">
            üìÇ Import Location History
        </button>
    </div>

    <!-- Achievements Panel -->
    <div class="panel" id="achievementsPanel">
        <div class="panel-header">
            <h2 class="panel-title">Achievements</h2>
            <button class="close-btn" onclick="closePanel('achievements')">√ó</button>
        </div>

        <div class="achievements-grid" id="achievementsGrid">
            <!-- Dynamically populated -->
        </div>
    </div>

    <!-- Leaderboard Panel -->
    <div class="panel" id="leaderboardPanel">
        <div class="panel-header">
            <h2 class="panel-title">Global Top 100</h2>
            <button class="close-btn" onclick="closePanel('leaderboard')">√ó</button>
        </div>

        <div class="leaderboard-list" id="leaderboardList">
            <!-- Dynamically populated -->
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Import Location History</h3>
                <button class="close-btn" onclick="closeModal('import')">√ó</button>
            </div>
            <div class="modal-body">
                <p>Upload your Google Location History to reveal all the places you've been!</p>
                <p style="font-size: 14px; color: var(--text-muted);">Supports: Google Takeout JSON, GPX files</p>
                
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <p style="font-weight: 600; margin-bottom: 8px;">Click to upload or drag & drop</p>
                    <p style="font-size: 12px; color: var(--text-muted);">JSON, GPX, or ZIP files</p>
                </div>
                <input type="file" id="fileInput" accept=".json,.gpx,.zip" style="display: none;" onchange="handleFileUpload(event)">
                
                <div id="uploadProgress" style="display: none; margin-top: var(--space-md);">
                    <p style="font-size: 14px; margin-bottom: var(--space-sm);">Processing: <span id="progressText">0%</span></p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('import')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Premium Upgrade Modal -->
    <div class="modal" id="premiumModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Unlock Premium</h3>
                <button class="close-btn" onclick="closeModal('premium')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: var(--space-lg);">
                    <div style="font-size: 64px; margin-bottom: var(--space-md);">üëë</div>
                    <h3 style="font-size: 24px; font-weight: 800; margin-bottom: var(--space-sm);">ExploreMap Premium</h3>
                    <p style="color: var(--text-secondary);">One-time payment. Lifetime access.</p>
                </div>

                <div style="background: var(--bg-tertiary); padding: var(--space-lg); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                    <p style="font-size: 14px; margin-bottom: var(--space-md);">‚úÖ Full location history import</p>
                    <p style="font-size: 14px; margin-bottom: var(--space-md);">‚úÖ Unlimited regions</p>
                    <p style="font-size: 14px; margin-bottom: var(--space-md);">‚úÖ Cloud sync across devices</p>
                    <p style="font-size: 14px; margin-bottom: var(--space-md);">‚úÖ GPX/JSON data export</p>
                    <p style="font-size: 14px; margin-bottom: 0;">‚úÖ Exclusive achievements</p>
                </div>

                <div style="text-align: center; margin-bottom: var(--space-lg);">
                    <div style="font-size: 48px; font-weight: 800; font-family: var(--font-mono);">$12<span style="font-size: 24px; color: var(--text-secondary);">.00</span></div>
                    <p style="font-size: 14px; color: var(--text-secondary);">One-time payment ‚Ä¢ No subscription</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('premium')">Maybe Later</button>
                <button class="btn btn-primary" onclick="initiatePremiumUpgrade()">
                    Unlock Premium
                </button>
            </div>
        </div>
    </div>

    <!-- Achievement Unlock Modal -->
    <div class="modal" id="achievementModal">
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 120px; margin-bottom: var(--space-lg);" id="achievementIcon">üéØ</div>
            <h3 style="font-size: 32px; font-weight: 800; margin-bottom: var(--space-sm);" id="achievementName">Achievement Unlocked!</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--space-xl);" id="achievementDesc">Description</p>
            <button class="btn btn-primary" onclick="closeModal('achievement')" style="width: 100%;">Awesome!</button>
        </div>
    </div>

    <!-- Canvas for Confetti -->
    <canvas class="confetti-canvas" id="confettiCanvas"></canvas>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        
        // FIREBASE SETUP INSTRUCTIONS:
        // 1. Go to console.firebase.google.com
        // 2. Create new project "ExploreMap"
        // 3. Enable Anonymous Authentication
        // 4. Create Realtime Database with rules (see design spec)
        // 5. Replace config below with your project's config
        
        const FIREBASE_CONFIG = {
            enabled: false, // Set to true after setup
            apiKey: "YOUR_API_KEY",
            authDomain: "exploremap.firebaseapp.com",
            databaseURL: "https://exploremap.firebaseio.com",
            projectId: "exploremap"
        };

        // STRIPE SETUP INSTRUCTIONS:
        // 1. Create account at stripe.com
        // 2. Create product "ExploreMap Premium" ($12 one-time)
        // 3. Get publishable key from dashboard
        // 4. Replace key below
        
        const STRIPE_CONFIG = {
            enabled: false, // Set to true after setup
            publishableKey: "pk_test_YOUR_KEY",
            priceId: "price_YOUR_PRICE_ID"
        };

        // ========================================
        // STATE MANAGEMENT
        // ========================================
        
        let map;
        let userMarker;
        let currentPosition = null;
        let discoveredCells = new Set();
        let achievements = [];
        let stats = {
            totalKm: 0,
            todayKm: 0,
            countries: new Set(),
            cities: new Set(),
            streak: 0,
            totalSteps: 0,
            viewpoints: 0,
            lastActiveDate: new Date().toDateString()
        };
        let isPremium = false;
        let watchId = null;

        // ========================================
        // INITIALIZATION
        // ========================================
        
        window.addEventListener('load', () => {
            initializeApp();
        });

        function initializeApp() {
            // Check if first visit
            const hasVisited = localStorage.getItem('hasVisited');
            if (!hasVisited) {
                document.getElementById('onboarding').style.display = 'flex';
            } else {
                document.getElementById('app').style.display = 'flex';
                initializeMap();
                loadData();
                startGPSTracking();
            }

            // Load achievements
            initializeAchievements();
            
            // Setup file upload drag & drop
            setupFileUpload();
        }

        function startOnboarding() {
            localStorage.setItem('hasVisited', 'true');
            document.getElementById('onboarding').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            // Request GPS permission
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentPosition = position;
                        initializeMap();
                        loadData();
                        startGPSTracking();
                    },
                    (error) => {
                        console.error("GPS error:", error);
                        alert("Please enable GPS to use ExploreMap");
                    }
                );
            }
        }

        // ========================================
        // MAP INITIALIZATION
        // ========================================
        
        function initializeMap() {
            const defaultLat = currentPosition ? currentPosition.coords.latitude : 51.505;
            const defaultLng = currentPosition ? currentPosition.coords.longitude : -0.09;

            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([defaultLat, defaultLng], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);

            // Add user marker
            if (currentPosition) {
                userMarker = L.circleMarker([defaultLat, defaultLng], {
                    radius: 10,
                    fillColor: '#00d9ff',
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
            }

            // Sync discovery canvas with map
            map.on('move', updateDiscoveryCanvas);
            map.on('zoom', updateDiscoveryCanvas);
        }

        // ========================================
        // GPS TRACKING
        // ========================================
        
        function startGPSTracking() {
            if ("geolocation" in navigator) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 30000
                };

                watchId = navigator.geolocation.watchPosition(
                    handlePositionUpdate,
                    handlePositionError,
                    options
                );
            }
        }

        function handlePositionUpdate(position) {
            currentPosition = position;
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // Update marker
            if (userMarker) {
                userMarker.setLatLng([lat, lng]);
            }

            // Check for discovery
            checkDiscovery(lat, lng);
            
            // Update stats
            updateStats();
        }

        function handlePositionError(error) {
            console.error("GPS error:", error);
        }

        // ========================================
        // DISCOVERY SYSTEM
        // ========================================
        
        function checkDiscovery(lat, lng) {
            // Simple grid-based discovery (50m cells)
            const cellSize = 0.0005; // ~50 meters
            const cellLat = Math.floor(lat / cellSize);
            const cellLng = Math.floor(lng / cellSize);
            const cellId = `${cellLat},${cellLng}`;

            if (!discoveredCells.has(cellId)) {
                discoveredCells.add(cellId);
                
                // Calculate area (approx 2,500 m¬≤ per cell = 0.0025 km¬≤)
                stats.totalKm += 0.0025;
                stats.todayKm += 0.0025;
                
                // Save to localStorage
                saveData();
                
                // Update UI
                updateStats();
                
                // Check achievements
                checkAchievements();
                
                // Update discovery overlay
                updateDiscoveryCanvas();
            }
        }

        function updateDiscoveryCanvas() {
            // Canvas overlay rendering would go here
            // For production, implement proper hexagonal grid rendering
            // This is a placeholder for the MVP
        }

        // ========================================
        // ACHIEVEMENTS SYSTEM
        // ========================================
        
        function initializeAchievements() {
            achievements = [
                { id: 'first', name: 'First Discovery', icon: 'üéØ', desc: 'Discover your first kilometer', threshold: 1, unlocked: false },
                { id: 'urban', name: 'Urban Pathfinder', icon: 'üèôÔ∏è', desc: 'Discover 50km in one city', threshold: 50, unlocked: false },
                { id: 'endurance', name: 'Endurance Trek', icon: 'üèîÔ∏è', desc: 'Discover 100km total', threshold: 100, unlocked: false },
                { id: 'globe', name: 'Globe Trotter', icon: 'üåç', desc: 'Visit 5 countries', threshold: 5, unlocked: false },
                { id: 'vista', name: 'Vista Collector', icon: 'üî≠', desc: 'Find 10 viewpoints', threshold: 10, unlocked: false },
                { id: 'streak', name: 'Streak Master', icon: 'üî•', desc: 'Maintain a 7-day streak', threshold: 7, unlocked: false },
                { id: 'challenge', name: 'Challenge Finisher', icon: '‚ö°', desc: 'Complete 5 challenges', threshold: 5, unlocked: false },
                { id: 'elite', name: 'Elite Ranker', icon: 'üëë', desc: 'Reach top 10 leaderboard', threshold: 10, unlocked: false }
            ];

            renderAchievements();
        }

        function renderAchievements() {
            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = '';

            achievements.forEach(achievement => {
                const card = document.createElement('div');
                card.className = `achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                
                let progress = '';
                if (!achievement.unlocked) {
                    let current = 0;
                    if (achievement.id === 'first' || achievement.id === 'urban' || achievement.id === 'endurance') {
                        current = stats.totalKm;
                    } else if (achievement.id === 'globe') {
                        current = stats.countries.size;
                    } else if (achievement.id === 'vista') {
                        current = stats.viewpoints;
                    } else if (achievement.id === 'streak') {
                        current = stats.streak;
                    }
                    progress = `<div class="achievement-progress">${current.toFixed(1)} / ${achievement.threshold}</div>`;
                }

                card.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                    ${progress}
                `;
                
                grid.appendChild(card);
            });
        }

        function checkAchievements() {
            achievements.forEach(achievement => {
                if (!achievement.unlocked) {
                    let shouldUnlock = false;

                    if (achievement.id === 'first' && stats.totalKm >= 1) shouldUnlock = true;
                    if (achievement.id === 'urban' && stats.totalKm >= 50) shouldUnlock = true;
                    if (achievement.id === 'endurance' && stats.totalKm >= 100) shouldUnlock = true;
                    if (achievement.id === 'globe' && stats.countries.size >= 5) shouldUnlock = true;
                    if (achievement.id === 'vista' && stats.viewpoints >= 10) shouldUnlock = true;
                    if (achievement.id === 'streak' && stats.streak >= 7) shouldUnlock = true;

                    if (shouldUnlock) {
                        achievement.unlocked = true;
                        showAchievementUnlock(achievement);
                        renderAchievements();
                        saveData();
                    }
                }
            });
        }

        function showAchievementUnlock(achievement) {
            // Show modal
            document.getElementById('achievementIcon').textContent = achievement.icon;
            document.getElementById('achievementName').textContent = achievement.name;
            document.getElementById('achievementDesc').textContent = achievement.desc;
            openModal('achievement');

            // Confetti!
            confetti({
                particleCount: 200,
                spread: 100,
                origin: { y: 0.6 }
            });
        }

        // ========================================
        // STATS SYSTEM
        // ========================================
        
        function updateStats() {
            // Check streak
            const today = new Date().toDateString();
            if (stats.lastActiveDate !== today) {
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                if (stats.lastActiveDate === yesterday) {
                    stats.streak++;
                } else {
                    stats.streak = 1;
                }
                stats.lastActiveDate = today;
                stats.todayKm = 0;
            }

            // Update UI
            document.getElementById('totalKm').textContent = stats.totalKm.toFixed(1);
            document.getElementById('todayKm').textContent = stats.todayKm.toFixed(1);
            document.getElementById('countries').textContent = stats.countries.size;
            document.getElementById('cities').textContent = stats.cities.size;
            document.getElementById('streakCount').textContent = stats.streak;
            document.getElementById('totalSteps').textContent = stats.totalSteps.toLocaleString();
            document.getElementById('viewpoints').textContent = stats.viewpoints;
        }

        // ========================================
        // DATA PERSISTENCE
        // ========================================
        
        function saveData() {
            const data = {
                stats: {
                    ...stats,
                    countries: Array.from(stats.countries),
                    cities: Array.from(stats.cities)
                },
                discoveredCells: Array.from(discoveredCells),
                achievements: achievements,
                isPremium: isPremium
            };
            localStorage.setItem('exploremapData', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('exploremapData');
            if (saved) {
                const data = JSON.parse(saved);
                stats = {
                    ...data.stats,
                    countries: new Set(data.stats.countries || []),
                    cities: new Set(data.stats.cities || [])
                };
                discoveredCells = new Set(data.discoveredCells || []);
                achievements = data.achievements || achievements;
                isPremium = data.isPremium || false;
                
                updateStats();
                renderAchievements();
            }
        }

        // ========================================
        // FILE IMPORT
        // ========================================
        
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                processFile(file);
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            if (!isPremium && file.size > 1048576) { // 1MB limit for free
                openModal('premium');
                return;
            }

            document.getElementById('uploadProgress').style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let locations = [];

                    if (file.name.endsWith('.json')) {
                        const json = JSON.parse(content);
                        // Parse Google Takeout format
                        if (json.locations) {
                            locations = json.locations.map(loc => ({
                                lat: loc.latitudeE7 / 1e7,
                                lng: loc.longitudeE7 / 1e7
                            }));
                        }
                    } else if (file.name.endsWith('.gpx')) {
                        // Parse GPX (simplified)
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(content, 'text/xml');
                        const trkpts = xml.getElementsByTagName('trkpt');
                        for (let pt of trkpts) {
                            locations.push({
                                lat: parseFloat(pt.getAttribute('lat')),
                                lng: parseFloat(pt.getAttribute('lon'))
                            });
                        }
                    }

                    // Process locations
                    let processed = 0;
                    const total = locations.length;
                    const batchSize = 100;

                    function processBatch() {
                        const end = Math.min(processed + batchSize, total);
                        for (let i = processed; i < end; i++) {
                            checkDiscovery(locations[i].lat, locations[i].lng);
                        }
                        processed = end;

                        // Update progress
                        const percent = Math.round((processed / total) * 100);
                        document.getElementById('progressText').textContent = `${percent}%`;
                        document.getElementById('progressFill').style.width = `${percent}%`;

                        if (processed < total) {
                            setTimeout(processBatch, 10);
                        } else {
                            // Complete
                            setTimeout(() => {
                                closeModal('import');
                                alert(`Successfully imported ${total.toLocaleString()} locations!`);
                                updateStats();
                                checkAchievements();
                            }, 500);
                        }
                    }

                    processBatch();

                } catch (error) {
                    alert('Error processing file: ' + error.message);
                    document.getElementById('uploadProgress').style.display = 'none';
                }
            };

            reader.readAsText(file);
        }

        // ========================================
        // UI CONTROLS
        // ========================================
        
        function showPanel(panel) {
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Hide all panels
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            // Show selected panel
            if (panel === 'stats') {
                document.getElementById('statsPanel').classList.add('active');
            } else if (panel === 'achievements') {
                document.getElementById('achievementsPanel').classList.add('active');
            } else if (panel === 'leaderboard') {
                document.getElementById('leaderboardPanel').classList.add('active');
                loadLeaderboard();
            }
        }

        function closePanel(panel) {
            document.getElementById(panel + 'Panel').classList.remove('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.nav-item').classList.add('active');
        }

        function openModal(modal) {
            document.getElementById(modal + 'Modal').classList.add('active');
        }

        function closeModal(modal) {
            document.getElementById(modal + 'Modal').classList.remove('active');
        }

        function openImportModal() {
            openModal('import');
        }

        function openSettings() {
            alert('Settings panel coming soon!');
        }

        // ========================================
        // MAP CONTROLS
        // ========================================
        
        function zoomIn() {
            if (map) map.zoomIn();
        }

        function zoomOut() {
            if (map) map.zoomOut();
        }

        function recenter() {
            if (map && currentPosition) {
                map.setView([currentPosition.coords.latitude, currentPosition.coords.longitude], 15);
            }
        }

        function toggleLayer() {
            // Toggle between different map styles
            alert('Layer toggle coming soon!');
        }

        // ========================================
        // LEADERBOARD
        // ========================================
        
        function loadLeaderboard() {
            const list = document.getElementById('leaderboardList');
            
            // Demo data (replace with Firebase sync)
            const demoData = [
                { rank: 1, nickname: 'Explorer_Pro', distance: '2,847.3', countries: 15, avatar: '#FF6B6B' },
                { rank: 2, nickname: 'Wanderer99', distance: '2,456.8', countries: 12, avatar: '#4ECDC4' },
                { rank: 3, nickname: 'MapMaster', distance: '2,103.2', countries: 18, avatar: '#FFE66D' },
                { rank: 42, nickname: 'You', distance: stats.totalKm.toFixed(1), countries: stats.countries.size, avatar: '#00d9ff', current: true }
            ];

            list.innerHTML = demoData.map(user => `
                <div class="leaderboard-row ${user.current ? 'current-user' : ''}">
                    <div class="rank ${user.rank <= 3 ? 'top-3' : ''}">#${user.rank}</div>
                    <div class="avatar" style="background: ${user.avatar}">${user.nickname.substring(0, 2).toUpperCase()}</div>
                    <div class="nickname">${user.nickname}</div>
                    <div class="stat-distance">${user.distance} km</div>
                    <div>üåç ${user.countries}</div>
                </div>
            `).join('');
        }

        // ========================================
        // PAYMENT INTEGRATION
        // ========================================
        
        function initiatePremiumUpgrade() {
            if (!STRIPE_CONFIG.enabled) {
                alert('Payment system not configured. See STRIPE_CONFIG in code.');
                return;
            }

            // Stripe checkout integration would go here
            alert('Stripe payment integration - see documentation');
        }

        // ========================================
        // SERVICE WORKER REGISTRATION
        // ========================================
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Service worker would be registered here for offline functionality
                // For single-file deployment, service worker is optional
            });
        }
    </script>
</body>
</html>
